from typing import List
from ..repositories import UserRepository
from ..models import User, Post


class NotificationService:
    """ĞÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ½Ñ‹Ğ¹ ÑĞµÑ€Ğ²Ğ¸Ñ Ğ´Ğ»Ñ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‹ Ñ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸ÑĞ¼Ğ¸"""

    @staticmethod
    async def get_users_to_notify(db, post: Post) -> List[User]:
        """ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹ Ğ´Ğ»Ñ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ñ Ğ¾ Ğ½Ğ¾Ğ²Ğ¾Ğ¼ Ğ¿Ğ¾ÑÑ‚Ğµ"""
        # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹ Ğ¿Ğ¾ Ğ³Ğ¾Ñ€Ğ¾Ğ´Ñƒ Ğ¸ ĞºĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ğ¸Ğ¸ Ğ¿Ğ¾ÑÑ‚Ğ°
        users = await UserRepository.get_users_by_city_and_categories(
            db, post.author.city, [post.category_id]
        )

        # Ğ˜ÑĞºĞ»ÑÑ‡Ğ°ĞµĞ¼ Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ° Ğ¿Ğ¾ÑÑ‚Ğ°
        return [user for user in users if user.id != post.author_id]

    @staticmethod
    def format_post_notification(post: Post) -> str:
        """Ğ¤Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğµ Ğ¾ Ğ¿Ğ¾ÑÑ‚Ğµ"""
        return (
            f"ğŸ“¢ ĞĞ¾Ğ²Ñ‹Ğ¹ Ğ¿Ğ¾ÑÑ‚ Ğ² ĞºĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ğ¸Ğ¸ '{post.category.name}'\n\n"
            f"ğŸ“ {post.title}\n\n"
            f"{post.content}\n\n"
            f"ğŸ‘¤ ĞĞ²Ñ‚Ğ¾Ñ€: {post.author.first_name or post.author.username or 'ĞĞ½Ğ¾Ğ½Ğ¸Ğ¼'}\n"
            f"ğŸ“… {post.published_at.strftime('%d.%m.%Y %H:%M') if post.published_at else ''}"
        )
